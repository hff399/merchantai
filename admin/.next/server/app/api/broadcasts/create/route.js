"use strict";(()=>{var e={};e.id=51,e.ids=[51],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8810:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>f,requestAsyncStorage:()=>l,routeModule:()=>p,serverHooks:()=>m,staticGenerationAsyncStorage:()=>g});var s={};r.r(s),r.d(s,{POST:()=>u});var a=r(9303),o=r(8716),i=r(670),n=r(7070),c=r(5662),d=r(9833);async function u(e){try{let{title:t,message:r,parseMode:s,targetType:a,targetTags:o,targetUserIds:i,sendNow:u}=await e.json();if(!r)return n.NextResponse.json({error:"Message is required"},{status:400});let p=c.p.from("users").select("id, telegram_id").eq("is_blocked",!1);"segment"===a&&o?.length>0?p=p.overlaps("tags",o):"specific"===a&&i?.length>0&&(p=p.in("id",i));let{data:l,error:g}=await p;if(g)return n.NextResponse.json({error:"Failed to fetch recipients"},{status:500});let{data:m,error:h}=await c.p.from("broadcasts").insert({title:t,message:r,message_html:"HTML"===s?r:null,parse_mode:s,target_type:a,target_tags:o||[],target_user_ids:i||[],total_recipients:l?.length||0,status:u?"sending":"draft"}).select().single();if(h)return n.NextResponse.json({error:"Failed to create broadcast"},{status:500});if(u&&l&&l.length>0){let e=l.map(e=>({broadcast_id:m.id,user_id:e.id,status:"pending"}));await c.p.from("broadcast_recipients").insert(e);let t=l.map(e=>({chat_id:e.telegram_id,text:r,parse_mode:s}));if(t.length<=100){let e=await (0,d.gy)(t);await c.p.from("broadcasts").update({status:"completed",sent_count:e.success,failed_count:e.failed,completed_at:new Date().toISOString()}).eq("id",m.id)}}return n.NextResponse.json({success:!0,broadcastId:m.id,recipientCount:l?.length||0})}catch(e){return console.error("Create broadcast error:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/broadcasts/create/route",pathname:"/api/broadcasts/create",filename:"route",bundlePath:"app/api/broadcasts/create/route"},resolvedPagePath:"/Users/leomishin/merchantai/admin/app/api/broadcasts/create/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:l,staticGenerationAsyncStorage:g,serverHooks:m}=p,h="/api/broadcasts/create/route";function f(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:g})}},5662:(e,t,r)=>{r.d(t,{p:()=>s});let s=(0,r(7857).eI)("https://lfeqwqcbhjkedclxihlw.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})},9833:(e,t,r)=>{r.d(t,{bG:()=>o,gy:()=>i});let s=process.env.TELEGRAM_BOT_TOKEN,a=`https://api.telegram.org/bot${s}`;async function o(e){try{let t=await fetch(`${a}/sendMessage`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),r=await t.json();if(r.ok)return{success:!0,message_id:r.result.message_id};return{success:!1,error:r.description}}catch(e){return{success:!1,error:String(e)}}}async function i(e,t=50){let r={success:0,failed:0,errors:[]};for(let s of e){let e=await o(s);e.success?r.success++:(r.failed++,r.errors.push(`Chat ${s.chat_id}: ${e.error}`)),await new Promise(e=>setTimeout(e,t))}return r}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[276,857,972],()=>r(8810));module.exports=s})();